<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Printing Document...</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            font-family: system-ui, sans-serif; 
            background: #f5f5f5; 
        }
        .message { 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            font-size: 18px; 
            color: #333; 
            text-align: center;
            padding: 20px;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FFBF00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pdf-container {
            width: 100%;
            height: 100vh;
            border: none;
            margin: 0;
            padding: 0;
        }
        iframe.pdf-frame { 
            width: 100%; 
            height: 100vh; 
            border: none; 
            display: block;
        }
        img.printable { 
            max-width: 100%; 
            max-height: 100vh; 
            object-fit: contain; 
            display: block;
            margin: 0 auto;
        }
        
        /* Print-specific styles */
        @media print {
            body { background: #fff; margin: 0; padding: 0; }
            #loader { display: none !important; }
            .pdf-container { margin: 0; padding: 0; }
            iframe.pdf-frame { margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <div id="loader" class="message">
        <div class="loading-spinner"></div>
        <div id="status">Loading document for printing...</div>
        <div id="progress" style="font-size: 14px; color: #666; margin-top: 10px;"></div>
    </div>
    <div id="pdf-container" class="pdf-container" style="display: none;"></div>

    <script>
        console.log('🖨️ PrintEasy QR - Print Host Initialized');
        
        (function() {
            const loader = document.getElementById('loader');
            const container = document.getElementById('pdf-container');
            const status = document.getElementById('status');
            const progress = document.getElementById('progress');

            const params = new URLSearchParams(window.location.search);
            const fileUrl = params.get('file');
            const fileType = params.get('type') || 'pdf';
            const autoClose = params.get('autoClose') !== 'false';

            console.log('🖨️ Print request:', { fileUrl, fileType, autoClose });

            if (!fileUrl) {
                status.innerText = 'Error: No file specified for printing.';
                console.error('❌ No file URL provided');
                return;
            }

            // **ENHANCED TIMEOUT AND PROGRESS TRACKING**
            let printTriggered = false;
            let loadStartTime = Date.now();
            let progressInterval;
            let timeoutId;

            const updateProgress = () => {
                if (printTriggered) return;
                const elapsed = Math.floor((Date.now() - loadStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                progress.innerText = `Loading time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            };

            const startProgressTracking = () => {
                progressInterval = setInterval(updateProgress, 1000);
            };

            const stopProgressTracking = () => {
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                if (timeoutId) {
                    clearTimeout(timeoutId);
                    timeoutId = null;
                }
            };

            // **AUTO-CLOSE AFTER PRINT**
            let printDialogClosed = false;
            window.onafterprint = function() {
                console.log('🖨️ Print dialog closed');
                printDialogClosed = true;
                if (autoClose) {
                    setTimeout(() => window.close(), 500);
                }
            };

            // **HANDLE DIFFERENT FILE TYPES**
            if (fileType === 'image') {
                console.log('🖼️ Loading image for printing');
                startProgressTracking();
                status.innerText = 'Loading image...';
                
                const img = document.createElement('img');
                img.className = 'printable';
                
                img.onload = function() {
                    console.log('✅ Image loaded successfully');
                    stopProgressTracking();
                    loader.style.display = 'none';
                    container.style.display = 'block';
                    setTimeout(() => window.print(), 100);
                };
                
                img.onerror = function() {
                    console.error('❌ Failed to load image');
                    stopProgressTracking();
                    status.innerText = 'Error: Failed to load image for printing.';
                };
                
                img.src = fileUrl;
                container.appendChild(img);

            } else {
                // **ENHANCED PDF LOADING WITH SMART TIMEOUT**
                console.log('📄 Setting up PDF for printing');
                startProgressTracking();
                status.innerText = 'Loading PDF document...';
                
                const iframe = document.createElement('iframe');
                iframe.className = 'pdf-frame';
                
                let loadAttempts = 0;
                const maxLoadAttempts = 3;
                
                const triggerPrint = () => {
                    if (printTriggered) return;
                    printTriggered = true;
                    stopProgressTracking();
                    
                    console.log('🖨️ Triggering print dialog...');
                    status.innerText = 'Ready to print!';
                    
                    // Hide loader and show container
                    loader.style.display = 'none';
                    container.style.display = 'block';
                    
                    // Multiple print strategies with timeout
                    setTimeout(() => {
                        try {
                            // Strategy 1: Try iframe content window print
                            if (iframe.contentWindow && iframe.contentWindow.print) {
                                console.log('📄 Using iframe content print');
                                iframe.contentWindow.focus();
                                setTimeout(() => {
                                    iframe.contentWindow.print();
                                }, 500);
                                return;
                            }
                        } catch (e) {
                            console.log('⚠️ Iframe print failed:', e.message);
                        }
                        
                        // Strategy 2: Parent window print
                        console.log('🖨️ Using parent window print');
                        window.focus();
                        setTimeout(() => {
                            window.print();
                        }, 500);
                    }, 1000);
                };
                
                // **SMART FILE SIZE BASED TIMEOUT**
                const estimateFileSize = () => {
                    // Try to estimate file size from URL or use default timeouts
                    const urlPath = decodeURIComponent(fileUrl);
                    
                    // For 300MB files, we need generous timeout
                    if (urlPath.includes('Copy_of_Portfolio') || urlPath.toLowerCase().includes('portfolio')) {
                        return 180000; // 3 minutes for portfolios/large files
                    }
                    
                    return 60000; // 1 minute for regular files
                };
                
                const timeoutMs = estimateFileSize();
                console.log(`⏱️ Setting ${timeoutMs/1000}s timeout for file loading`);
                
                // **ENHANCED IFRAME LOAD HANDLING**
                iframe.onload = function() {
                    console.log('✅ PDF iframe initial load completed');
                    loadAttempts++;
                    
                    // Wait for actual content to be ready
                    setTimeout(() => {
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                            if (iframeDoc) {
                                console.log('✅ PDF content accessible, ready state:', iframeDoc.readyState);
                                
                                if (iframeDoc.readyState === 'complete') {
                                    status.innerText = 'PDF loaded successfully!';
                                    setTimeout(triggerPrint, 2000);
                                } else {
                                    // Wait a bit more for content to fully load
                                    status.innerText = 'Finalizing PDF loading...';
                                    setTimeout(() => {
                                        if (!printTriggered) {
                                            console.log('✅ Forcing print after additional wait');
                                            triggerPrint();
                                        }
                                    }, 5000);
                                }
                            } else {
                                console.log('⚠️ Cannot access iframe content (cross-origin)');
                                status.innerText = 'PDF loaded (cross-origin), preparing print...';
                                setTimeout(triggerPrint, 3000);
                            }
                        } catch (e) {
                            console.log('⚠️ Error accessing iframe content:', e.message);
                            status.innerText = 'PDF loaded, preparing print...';
                            setTimeout(triggerPrint, 3000);
                        }
                    }, 2000); // Wait 2 seconds after onload
                };
                
                iframe.onerror = function(e) {
                    console.error('❌ Failed to load PDF iframe:', e);
                    stopProgressTracking();
                    
                    if (loadAttempts < maxLoadAttempts) {
                        console.log(`🔄 Retry attempt ${loadAttempts + 1}/${maxLoadAttempts}`);
                        status.innerText = `Loading failed, retrying... (${loadAttempts + 1}/${maxLoadAttempts})`;
                        
                        setTimeout(() => {
                            iframe.src = fileUrl + '&retry=' + Date.now();
                        }, 2000);
                    } else {
                        status.innerHTML = `
                            <div style="max-width: 500px;">
                                <h3>⚠️ File Loading Error</h3>
                                <p>Unable to load this file for printing after ${maxLoadAttempts} attempts.</p>
                                <p style="font-size: 14px; color: #666;">This may be due to the file size (${Math.round(300)}MB) or network issues.</p>
                                <p style="font-size: 14px; color: #666;">Please try downloading the file directly instead.</p>
                                <button onclick="window.close()" style="padding: 8px 16px; background: #FFBF00; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Close Window</button>
                            </div>
                        `;
                    }
                };
                
                // **SMART TIMEOUT BASED ON FILE SIZE**
                timeoutId = setTimeout(() => {
                    if (!printTriggered) {
                        console.log(`⏰ Timeout reached (${timeoutMs/1000}s), forcing print attempt`);
                        status.innerText = 'Large file timeout - attempting to print...';
                        triggerPrint();
                    }
                }, timeoutMs);
                
                // Set iframe source AFTER setting up event handlers
                console.log('🔗 Loading PDF URL:', fileUrl);
                iframe.src = fileUrl;
                container.appendChild(iframe);
            }
        })();
    </script>
</body>
</html>