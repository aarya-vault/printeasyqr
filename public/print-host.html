<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Printing Document...</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: system-ui, sans-serif; background: #f5f5f5; }
        .message { display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 18px; color: #333; }
        img.printable { max-width: 100%; max-height: 100%; object-fit: contain; }
        iframe { width: 100%; height: 100%; border: none; }
        /* Print-specific styles */
        @media print {
            body { background: #fff; }
            #loader { display: none; }
            .page-container { margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <div id="loader" class="message">Loading document for printing...</div>
    <div id="page-container" style="display: none;"></div>

    <script>
        (function() {
            const loader = document.getElementById('loader');
            const container = document.getElementById('page-container');

            const params = new URLSearchParams(window.location.search);
            const fileUrl = params.get('file');
            const fileType = params.get('type') || 'pdf'; // Default to pdf if no type is specified
            const autoClose = params.get('autoClose') !== 'false';

            if (!fileUrl) {
                loader.innerText = 'Error: No file specified.';
                return;
            }

            // **THE RELIABLE AUTO-CLOSE LOGIC**
            // This event fires AFTER the print dialog is closed.
            window.onafterprint = function() {
                if (autoClose) {
                    window.close();
                }
            };
            
            // --- SMART FILE HANDLING ---

            if (fileType === 'image') {
                // Handle images with an <img> tag
                const img = document.createElement('img');
                img.className = 'printable';
                img.onload = function() {
                    loader.style.display = 'none';
                    container.style.display = 'block';
                    window.print();
                };
                img.onerror = function() {
                    loader.innerText = 'Error: Failed to load image.';
                };
                img.src = fileUrl;
                container.appendChild(img);

            } else {
                // üñ®Ô∏è DIRECT PDF PRINTING: Force browser to display PDF for printing instead of downloading
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                
                // Force PDF to display inline instead of downloading
                const printUrl = new URL(fileUrl, window.location.origin);
                printUrl.searchParams.set('inline', 'true'); // Force inline display
                printUrl.searchParams.delete('download'); // Remove any download flags
                
                iframe.onload = function() {
                    loader.style.display = 'none';
                    container.style.display = 'block';
                    
                    // Give PDF time to render, then trigger print
                    setTimeout(function() {
                        try {
                            // Focus on the iframe first
                            iframe.contentWindow.focus();
                            
                            // Try printing from iframe content (for PDF plugins)
                            if (iframe.contentWindow && typeof iframe.contentWindow.print === 'function') {
                                console.log('üñ®Ô∏è Printing via iframe content window');
                                iframe.contentWindow.print();
                            } else {
                                throw new Error('No iframe print method available');
                            }
                        } catch (e) {
                            console.log('üñ®Ô∏è Fallback: Printing via parent window:', e.message);
                            // Fallback to parent window print
                            window.print();
                        }
                    }, 1000); // Increased delay for PDF rendering
                };
                
                iframe.onerror = function() {
                    loader.innerText = 'Error: Failed to load document for printing.';
                };
                
                // Set src with inline display parameters
                iframe.src = printUrl.toString();
                container.appendChild(iframe);
            }
        })();
    </script>
</body>
</html>