<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Printing Document...</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            font-family: system-ui, sans-serif; 
            background: #f5f5f5; 
        }
        .message { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            font-size: 18px; 
            color: #333; 
        }
        .pdf-container {
            width: 100%;
            height: 100vh;
            border: none;
            margin: 0;
            padding: 0;
        }
        iframe.pdf-frame { 
            width: 100%; 
            height: 100vh; 
            border: none; 
            display: block;
        }
        img.printable { 
            max-width: 100%; 
            max-height: 100vh; 
            object-fit: contain; 
            display: block;
            margin: 0 auto;
        }
        
        /* Print-specific styles */
        @media print {
            body { background: #fff; margin: 0; padding: 0; }
            #loader { display: none !important; }
            .pdf-container { margin: 0; padding: 0; }
            iframe.pdf-frame { margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <div id="loader" class="message">Loading document for printing...</div>
    <div id="pdf-container" class="pdf-container" style="display: none;"></div>

    <script>
        console.log('üñ®Ô∏è PrintEasy QR - Direct Print Host Initialized');
        
        (function() {
            const loader = document.getElementById('loader');
            const container = document.getElementById('pdf-container');

            const params = new URLSearchParams(window.location.search);
            const fileUrl = params.get('file');
            const fileType = params.get('type') || 'pdf';
            const autoClose = params.get('autoClose') !== 'false';

            console.log('üñ®Ô∏è Print request:', { fileUrl, fileType, autoClose });

            if (!fileUrl) {
                loader.innerText = 'Error: No file specified for printing.';
                console.error('‚ùå No file URL provided');
                return;
            }

            // **BULLETPROOF AUTO-CLOSE AFTER PRINT**
            let printDialogClosed = false;
            window.onafterprint = function() {
                console.log('üñ®Ô∏è Print dialog closed');
                printDialogClosed = true;
                if (autoClose) {
                    setTimeout(() => window.close(), 500);
                }
            };

            // **HANDLE DIFFERENT FILE TYPES**
            if (fileType === 'image') {
                console.log('üñºÔ∏è Loading image for printing');
                const img = document.createElement('img');
                img.className = 'printable';
                img.onload = function() {
                    console.log('‚úÖ Image loaded, triggering print');
                    loader.style.display = 'none';
                    container.style.display = 'block';
                    // Small delay to ensure image is rendered
                    setTimeout(() => window.print(), 100);
                };
                img.onerror = function() {
                    console.error('‚ùå Failed to load image');
                    loader.innerText = 'Error: Failed to load image for printing.';
                };
                img.src = fileUrl;
                container.appendChild(img);

            } else {
                // **BULLETPROOF PDF PRINTING - LOAD FIRST, THEN PRINT**
                console.log('üìÑ Setting up PDF for direct printing');
                
                // Create iframe with proper PDF display parameters
                const iframe = document.createElement('iframe');
                iframe.className = 'pdf-frame';
                
                // Ensure the fileUrl already has the correct parameters from print-helpers.ts
                console.log('üîó PDF URL:', fileUrl);
                
                let printTriggered = false;
                
                // **LOAD-BASED PRINT STRATEGY** - Only print after file is fully loaded
                const triggerPrint = () => {
                    if (printTriggered) return;
                    printTriggered = true;
                    
                    console.log('üñ®Ô∏è File loaded, triggering print dialog...');
                    
                    // Strategy 1: Try iframe content window print first (best for PDFs)
                    try {
                        if (iframe.contentWindow && iframe.contentWindow.print) {
                            console.log('üìÑ Using iframe content print');
                            iframe.contentWindow.focus();
                            iframe.contentWindow.print();
                            return;
                        }
                    } catch (e) {
                        console.log('‚ö†Ô∏è Iframe print failed:', e.message);
                    }
                    
                    // Strategy 2: Parent window print as fallback
                    console.log('üñ®Ô∏è Using parent window print (fallback)');
                    window.focus();
                    window.print();
                };
                
                // **WAIT FOR FULL LOAD** - Critical for large files
                iframe.onload = function() {
                    console.log('‚úÖ PDF fully loaded, ready to print');
                    
                    // Hide loader and show container
                    loader.style.display = 'none';
                    container.style.display = 'block';
                    
                    // Give browser a moment to render, then print
                    setTimeout(triggerPrint, 300);
                };
                
                iframe.onerror = function() {
                    console.error('‚ùå Failed to load PDF iframe');
                    loader.innerText = 'Error: Failed to load document for printing.';
                };
                
                // **TIMEOUT FALLBACK FOR VERY LARGE FILES**
                // If file takes longer than 60 seconds, something is wrong
                setTimeout(() => {
                    if (!printTriggered) {
                        console.log('‚è∞ Large file timeout (60s), forcing print attempt');
                        loader.innerText = 'Large file detected - attempting to print...';
                        triggerPrint();
                    }
                }, 60000); // 60 second timeout for massive files
                
                // Set iframe source AFTER setting up event handlers
                iframe.src = fileUrl;
                container.appendChild(iframe);
            }
        })();
    </script>
</body>
</html>