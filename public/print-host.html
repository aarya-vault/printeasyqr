<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Printing Document...</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            font-family: system-ui, sans-serif; 
            background: #f5f5f5; 
        }
        .message { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            font-size: 18px; 
            color: #333; 
        }
        .pdf-container {
            width: 100%;
            height: 100vh;
            border: none;
            margin: 0;
            padding: 0;
        }
        iframe.pdf-frame { 
            width: 100%; 
            height: 100vh; 
            border: none; 
            display: block;
        }
        img.printable { 
            max-width: 100%; 
            max-height: 100vh; 
            object-fit: contain; 
            display: block;
            margin: 0 auto;
        }
        
        /* Print-specific styles */
        @media print {
            body { background: #fff; margin: 0; padding: 0; }
            #loader { display: none !important; }
            .pdf-container { margin: 0; padding: 0; }
            iframe.pdf-frame { margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <div id="loader" class="message">Loading document for printing...</div>
    <div id="pdf-container" class="pdf-container" style="display: none;"></div>

    <script>
        console.log('üñ®Ô∏è PrintEasy QR - Direct Print Host Initialized');
        
        (function() {
            const loader = document.getElementById('loader');
            const container = document.getElementById('pdf-container');

            const params = new URLSearchParams(window.location.search);
            const fileUrl = params.get('file');
            const fileType = params.get('type') || 'pdf';
            const autoClose = params.get('autoClose') !== 'false';

            console.log('üñ®Ô∏è Print request:', { fileUrl, fileType, autoClose });

            if (!fileUrl) {
                loader.innerText = 'Error: No file specified for printing.';
                console.error('‚ùå No file URL provided');
                return;
            }

            // **BULLETPROOF AUTO-CLOSE AFTER PRINT**
            let printDialogClosed = false;
            window.onafterprint = function() {
                console.log('üñ®Ô∏è Print dialog closed');
                printDialogClosed = true;
                if (autoClose) {
                    setTimeout(() => window.close(), 500);
                }
            };

            // **HANDLE DIFFERENT FILE TYPES**
            if (fileType === 'image') {
                console.log('üñºÔ∏è Loading image for printing');
                const img = document.createElement('img');
                img.className = 'printable';
                img.onload = function() {
                    console.log('‚úÖ Image loaded, triggering print');
                    loader.style.display = 'none';
                    container.style.display = 'block';
                    // Small delay to ensure image is rendered
                    setTimeout(() => window.print(), 100);
                };
                img.onerror = function() {
                    console.error('‚ùå Failed to load image');
                    loader.innerText = 'Error: Failed to load image for printing.';
                };
                img.src = fileUrl;
                container.appendChild(img);

            } else {
                // **BULLETPROOF PDF PRINTING - LOAD FIRST, THEN PRINT**
                console.log('üìÑ Setting up PDF for direct printing');
                
                // Create iframe with proper PDF display parameters
                const iframe = document.createElement('iframe');
                iframe.className = 'pdf-frame';
                
                // Ensure the fileUrl already has the correct parameters from print-helpers.ts
                console.log('üîó PDF URL:', fileUrl);
                
                let printTriggered = false;
                
                // **ENHANCED PRINT STRATEGY** - Multiple fallbacks for ultra large files
                const triggerPrint = () => {
                    if (printTriggered) return;
                    printTriggered = true;
                    
                    console.log('üñ®Ô∏è Ultra-large file ready, triggering print dialog...');
                    
                    // Strategy 1: Try iframe content window print first (best for PDFs)
                    try {
                        if (iframe.contentWindow && iframe.contentWindow.print) {
                            console.log('üìÑ Using iframe content print for large file');
                            iframe.contentWindow.focus();
                            
                            // Give browser extra time to focus on large content
                            setTimeout(() => {
                                iframe.contentWindow.print();
                            }, 1000);
                            return;
                        }
                    } catch (e) {
                        console.log('‚ö†Ô∏è Iframe print failed for large file:', e.message);
                    }
                    
                    // Strategy 2: Force parent window focus and print for large files
                    console.log('üñ®Ô∏è Using parent window print for large file (fallback)');
                    try {
                        window.focus();
                        // Longer delay for large files
                        setTimeout(() => {
                            window.print();
                        }, 1500);
                    } catch (e) {
                        console.log('‚ùå All print strategies failed:', e.message);
                        loader.innerText = 'Print failed. Please try downloading the file instead.';
                        loader.style.display = 'block';
                        container.style.display = 'none';
                    }
                };
                
                // **WAIT FOR FULL LOAD** - Critical for ULTRA LARGE files
                iframe.onload = function() {
                    console.log('‚úÖ PDF iframe loaded, checking if content is ready...');
                    
                    // For ULTRA large files, wait longer for rendering
                    setTimeout(() => {
                        try {
                            // Check if iframe content is accessible
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                            if (iframeDoc && iframeDoc.readyState === 'complete') {
                                console.log('‚úÖ PDF content fully ready, triggering print');
                                
                                // Hide loader and show container
                                loader.style.display = 'none';
                                container.style.display = 'block';
                                
                                // Longer delay for large files to ensure rendering
                                setTimeout(triggerPrint, 2000); // 2 seconds for large files
                            } else {
                                console.log('‚ö†Ô∏è PDF content not fully ready, retrying...');
                                // Fallback: just hide loader and try anyway
                                loader.style.display = 'none';
                                container.style.display = 'block';
                                setTimeout(triggerPrint, 5000); // 5 seconds fallback
                            }
                        } catch (e) {
                            console.log('‚ö†Ô∏è Cannot access iframe content, using fallback');
                            // Cross-origin or blocked content - use fallback
                            loader.style.display = 'none';
                            container.style.display = 'block';
                            setTimeout(triggerPrint, 5000); // 5 seconds fallback
                        }
                    }, 1000); // Wait 1 second after onload for large files
                };
                
                iframe.onerror = function(e) {
                    console.error('‚ùå Failed to load PDF iframe:', e);
                    console.log('üîç File URL that failed:', fileUrl);
                    loader.innerText = 'Error: Ultra-large file failed to load. Try downloading instead.';
                    
                    // Show error details for debugging
                    setTimeout(() => {
                        loader.innerHTML = `
                            <div style="text-align: center; padding: 20px; max-width: 600px;">
                                <h3>‚ö†Ô∏è Large File Loading Issue</h3>
                                <p>This file (likely 100MB+) is too large to display in the print preview.</p>
                                <p style="font-size: 14px; color: #666;">Please close this window and try downloading the file directly instead.</p>
                                <button onclick="window.close()" style="padding: 10px 20px; background: #FFBF00; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Close Window</button>
                            </div>
                        `;
                    }, 2000);
                };
                
                // **TIMEOUT FALLBACK FOR ULTRA LARGE FILES**
                // MASSIVE timeout for 100-200MB files - 15 MINUTES!
                setTimeout(() => {
                    if (!printTriggered) {
                        console.log('‚è∞ Ultra-large file timeout (900s), forcing print attempt');
                        loader.innerText = 'Ultra-large file (100MB+) - forcing print...';
                        triggerPrint();
                    }
                }, 900000); // 15 MINUTES for 100-200MB files
                
                // **PROGRESS MONITORING FOR LARGE FILES**
                let progressCheck = 0;
                const progressInterval = setInterval(() => {
                    progressCheck++;
                    if (!printTriggered) {
                        const minutes = Math.floor(progressCheck * 10 / 60);
                        const seconds = (progressCheck * 10) % 60;
                        loader.innerText = `Loading large file... ${minutes}:${seconds.toString().padStart(2, '0')} elapsed`;
                        console.log(`üìä Large file progress: ${progressCheck * 10}s elapsed`);
                    } else {
                        clearInterval(progressInterval);
                    }
                }, 10000); // Update every 10 seconds
                
                // Set iframe source AFTER setting up event handlers
                iframe.src = fileUrl;
                container.appendChild(iframe);
            }
        })();
    </script>
</body>
</html>