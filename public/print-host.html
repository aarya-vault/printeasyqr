<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Printing Document...</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            font-family: system-ui, sans-serif; 
            background: #f5f5f5; 
        }
        .message { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            font-size: 18px; 
            color: #333; 
        }
        .pdf-container {
            width: 100%;
            height: 100vh;
            border: none;
            margin: 0;
            padding: 0;
        }
        iframe.pdf-frame { 
            width: 100%; 
            height: 100vh; 
            border: none; 
            display: block;
        }
        img.printable { 
            max-width: 100%; 
            max-height: 100vh; 
            object-fit: contain; 
            display: block;
            margin: 0 auto;
        }
        
        /* Print-specific styles */
        @media print {
            body { background: #fff; margin: 0; padding: 0; }
            #loader { display: none !important; }
            .pdf-container { margin: 0; padding: 0; }
            iframe.pdf-frame { margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <div id="loader" class="message">Loading document for printing...</div>
    <div id="pdf-container" class="pdf-container" style="display: none;"></div>

    <script>
        console.log('üñ®Ô∏è PrintEasy QR - Direct Print Host Initialized');
        
        (function() {
            const loader = document.getElementById('loader');
            const container = document.getElementById('pdf-container');

            const params = new URLSearchParams(window.location.search);
            const fileUrl = params.get('file');
            const fileType = params.get('type') || 'pdf';
            const autoClose = params.get('autoClose') !== 'false';

            console.log('üñ®Ô∏è Print request:', { fileUrl, fileType, autoClose });

            if (!fileUrl) {
                loader.innerText = 'Error: No file specified for printing.';
                console.error('‚ùå No file URL provided');
                return;
            }

            // **BULLETPROOF AUTO-CLOSE AFTER PRINT**
            let printDialogClosed = false;
            window.onafterprint = function() {
                console.log('üñ®Ô∏è Print dialog closed');
                printDialogClosed = true;
                if (autoClose) {
                    setTimeout(() => window.close(), 500);
                }
            };

            // **HANDLE DIFFERENT FILE TYPES**
            if (fileType === 'image') {
                console.log('üñºÔ∏è Loading image for printing');
                const img = document.createElement('img');
                img.className = 'printable';
                img.onload = function() {
                    console.log('‚úÖ Image loaded, triggering print');
                    loader.style.display = 'none';
                    container.style.display = 'block';
                    // Small delay to ensure image is rendered
                    setTimeout(() => window.print(), 100);
                };
                img.onerror = function() {
                    console.error('‚ùå Failed to load image');
                    loader.innerText = 'Error: Failed to load image for printing.';
                };
                img.src = fileUrl;
                container.appendChild(img);

            } else {
                // **BULLETPROOF PDF PRINTING**
                console.log('üìÑ Setting up PDF for direct printing');
                
                // Create iframe with proper PDF display parameters
                const iframe = document.createElement('iframe');
                iframe.className = 'pdf-frame';
                
                // Ensure the fileUrl already has the correct parameters from print-helpers.ts
                console.log('üîó PDF URL:', fileUrl);
                
                let pdfLoaded = false;
                let printTriggered = false;
                
                // **IMMEDIATE PRINT STRATEGY** - Don't wait for iframe load, use multiple approaches
                const triggerPrint = () => {
                    if (printTriggered) return;
                    printTriggered = true;
                    
                    console.log('üñ®Ô∏è Triggering print dialog immediately...');
                    
                    // Strategy 1: Direct parent window print (most reliable)
                    window.focus();
                    setTimeout(() => {
                        window.print();
                    }, 100);
                };
                
                // **CRITICAL FIX**: Set iframe src and trigger print immediately
                iframe.src = fileUrl;
                container.appendChild(iframe);
                
                // Hide loader and show container immediately
                loader.style.display = 'none';
                container.style.display = 'block';
                
                // Trigger print immediately without waiting for iframe load
                setTimeout(triggerPrint, 500);
                
                // **BACKUP STRATEGIES**
                iframe.onload = function() {
                    console.log('‚úÖ PDF iframe loaded as backup');
                    
                    // If print hasn't been triggered yet, try iframe print
                    if (!printTriggered) {
                        try {
                            if (iframe.contentWindow && iframe.contentWindow.print) {
                                console.log('üìÑ Attempting iframe content print as backup');
                                iframe.contentWindow.focus();
                                iframe.contentWindow.print();
                                printTriggered = true;
                                return;
                            }
                        } catch (e) {
                            console.log('‚ö†Ô∏è Iframe print failed, using parent window:', e.message);
                        }
                        
                        // Final fallback
                        if (!printTriggered) {
                            triggerPrint();
                        }
                    }
                };
                
                iframe.onerror = function() {
                    console.error('‚ùå Failed to load PDF iframe, using direct print');
                    if (!printTriggered) {
                        triggerPrint();
                    }
                };
                
                // **FINAL TIMEOUT FALLBACK** - Absolutely ensure print happens
                setTimeout(() => {
                    if (!printTriggered) {
                        console.log('‚è∞ Final timeout reached, forcing print');
                        triggerPrint();
                    }
                }, 2000);
            }
        })();
    </script>
</body>
</html>