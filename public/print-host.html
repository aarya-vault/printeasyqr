<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printing...</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            overflow: hidden; 
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
        }
        iframe { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            border: none; 
        }
        .message { 
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 18px;
            color: #333;
        }
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="loader" class="message loading">Loading document for printing...</div>
    <script>
        (function() {
            // Get the file URL from the query parameter
            const params = new URLSearchParams(window.location.search);
            const fileUrl = params.get('file');
            const autoClose = params.get('autoClose') !== 'false'; // Default to true

            if (!fileUrl) {
                document.getElementById('loader').innerText = 'Error: No file specified.';
                document.getElementById('loader').classList.remove('loading');
                return;
            }

            // Create an iframe to securely load the PDF
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none'; // Hide initially
            
            iframe.onload = function() {
                try {
                    // Hide loader and show iframe
                    document.getElementById('loader').style.display = 'none';
                    iframe.style.display = 'block';
                    
                    // Small delay to ensure PDF is fully rendered
                    setTimeout(() => {
                        try {
                            // Focus and print
                            iframe.contentWindow.focus();
                            iframe.contentWindow.print();
                            
                            // Auto-close after print dialog is handled
                            if (autoClose) {
                                setTimeout(() => {
                                    window.close();
                                }, 1000);
                            }
                        } catch (e) {
                            // Fallback: use window.print() if iframe print fails
                            window.print();
                            if (autoClose) {
                                setTimeout(() => {
                                    window.close();
                                }, 1000);
                            }
                        }
                    }, 500);
                } catch (e) {
                    document.getElementById('loader').innerText = 'Error: Could not trigger print dialog.';
                    document.getElementById('loader').classList.remove('loading');
                    document.getElementById('loader').style.display = 'block';
                    console.error('Print trigger failed:', e);
                }
            };

            iframe.onerror = function() {
                document.getElementById('loader').innerText = 'Error: Failed to load the file.';
                document.getElementById('loader').classList.remove('loading');
            };
            
            // Add the iframe to body
            iframe.src = fileUrl;
            document.body.appendChild(iframe);
            
            // Timeout fallback - if nothing happens in 10 seconds, show error
            setTimeout(() => {
                const loader = document.getElementById('loader');
                if (loader && loader.style.display !== 'none') {
                    loader.innerText = 'Error: Document loading timeout. Please try again.';
                    loader.classList.remove('loading');
                }
            }, 10000);
        })();
    </script>
</body>
</html>