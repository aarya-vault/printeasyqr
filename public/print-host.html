<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Printing Document...</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: system-ui, sans-serif; background: #f5f5f5; }
        .message { display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 18px; color: #333; }
        img.printable { max-width: 100%; max-height: 100%; object-fit: contain; }
        iframe { width: 100%; height: 100%; border: none; }
        /* Print-specific styles */
        @media print {
            body { background: #fff; }
            #loader { display: none; }
            .page-container { margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <div id="loader" class="message">Loading document for printing...</div>
    <div id="page-container" style="display: none;"></div>

    <script>
        (function() {
            const loader = document.getElementById('loader');
            const container = document.getElementById('page-container');

            const params = new URLSearchParams(window.location.search);
            const fileUrl = params.get('file');
            const fileType = params.get('type') || 'pdf'; // Default to pdf if no type is specified
            const autoClose = params.get('autoClose') !== 'false';

            if (!fileUrl) {
                loader.innerText = 'Error: No file specified.';
                return;
            }

            // **THE RELIABLE AUTO-CLOSE LOGIC**
            // This event fires AFTER the print dialog is closed.
            window.onafterprint = function() {
                if (autoClose) {
                    window.close();
                }
            };
            
            // --- SMART FILE HANDLING ---

            if (fileType === 'image') {
                // Handle images with an <img> tag
                const img = document.createElement('img');
                img.className = 'printable';
                img.onload = function() {
                    loader.style.display = 'none';
                    container.style.display = 'block';
                    window.print();
                };
                img.onerror = function() {
                    loader.innerText = 'Error: Failed to load image.';
                };
                img.src = fileUrl;
                container.appendChild(img);

            } else {
                // üñ®Ô∏è ENHANCED PDF HANDLING: Better iframe implementation for printing
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                
                // Add print parameter to URL if not present
                const printUrl = new URL(fileUrl, window.location.origin);
                if (!printUrl.searchParams.has('print')) {
                    printUrl.searchParams.set('print', 'true');
                }
                
                iframe.onload = function() {
                    loader.style.display = 'none';
                    container.style.display = 'block';
                    
                    // Delay print dialog to ensure PDF is fully rendered
                    setTimeout(function() {
                        try {
                            // Try to access iframe content
                            if (iframe.contentWindow && iframe.contentWindow.document) {
                                // Check if PDF plugin is available
                                const iframeDoc = iframe.contentWindow.document;
                                if (iframeDoc.contentType === 'application/pdf' || 
                                    iframeDoc.querySelector('embed[type="application/pdf"]')) {
                                    // PDF is loaded, trigger print
                                    iframe.contentWindow.focus();
                                    iframe.contentWindow.print();
                                } else {
                                    // Not a PDF or not loaded properly, use parent window print
                                    window.print();
                                }
                            } else {
                                // Can't access iframe (cross-origin), use parent print
                                window.print();
                            }
                        } catch (e) {
                            console.log("Print via parent window due to:", e.message);
                            window.print(); // Fallback for any issues
                        }
                    }, 500); // 500ms delay for PDF rendering
                };
                
                iframe.onerror = function() {
                    loader.innerText = 'Error: Failed to load document.';
                };
                
                // Use the modified URL with print parameter
                iframe.src = printUrl.toString();
                container.appendChild(iframe);
            }
        })();
    </script>
</body>
</html>